# Swarm and Kubernetes Wordsmith Demo

Wordsmith is the demo project shown at DockerCon EU 2017, where Docker announced that support for Kubernetes was coming to the Docker platform.

The demo app runs across three containers:

- [db](db/Dockerfile) - a Postgres database which stores words

- [api](api/Dockerfile) - a Java REST API which serves words read from the database

- [web](web/Dockerfile) - a Go web application which calls the API and builds words into sentences:

![The Wordsmith app running in Kubernetes on Docker for Mac](img/dockercon_EU_17.jpg)

Static IPs set by default:
- `ucp` (UCP manager node): 172.28.128.31
- `dtr` (DTR replica): 172.28.128.34
- `worker-node1` (Worker node): 172.28.128.35
- `worker-node2` (Worker node): 172.28.128.36

## Build

The only requirement to build and run the app from source is Docker. Clone this repo and use Docker Compose to build all the images:

```
$ git clone https://github.com/jeromebaude/k8s-wordsmith-demo
$ cd k8s-wordsmith-demo
$ git checkout update/container_to_kube
$ docker-compose build
```

Once your images are built, you can push them to your own repository (DTR)

```
$ docker login
$ docker push jeromebaude/k8s-wordsmith
```


## Deploy as a local Docker Stack

The latest version of [Docker for Mac/Windows](https://www.docker.com/docker-mac) has Swarm and Kubernetes built-in.

Docker lets you use the simple [Docker Compose](https://docs.docker.com/compose/) file format to deploy complex applications to Swarm and Kubernetes. You can deploy the wordsmith app to the local node using [docker-compose.yml](docker-compose.yml).

First use `docker version` to check whether Docker is running with Swarm or Kubernetes - Docker for Mac/Windows supports both orchestrators **at the same time**:

```
$ docker version -f '{{ .Client.Orchestrator }}'
```

> You can switch orchestrators with the `DOCKER_ORCHESTRATOR` environment variable, setting it to `kubernetes` or `swarm`. Docker for Mac/Windows Edge has both Kubernetes and Swarm support. Docker for Mac/Windows stable only supports Swarm

Create a local Swarm cluster
```
$ export DOCKER_ORCHESTRATOR=swarm
$ docker swarm init
```

Deploy the app to Swarm as a stack using the [compose file](docker-compose.yml):

```
$ docker stack deploy -c docker-compose.yml words
```

Check that your stack runs the 3 services
```
$ docker services ls
ID                  NAME                MODE                REPLICAS            IMAGE                                  PORTS
jikom7jeuac7        wordsmith_api       replicated          5/5                 jeromebaude/k8s-wordsmith-api:latest
vx1p96ppgxvo        wordsmith_db        replicated          1/1                 jeromebaude/k8s-wordsmith-db:latest
gemz9w4f4su1        wordsmith_web       replicated          1/1                 jeromebaude/k8s-wordsmith-web:latest   *:8081->80/tcp
```

Then browse to http://localhost:8081 to see the site. Each time you refresh the page, you'll see a different sentence generated by the API calls.

QUESTION: What is the ID and IP adress displayed below each word?

When you are done, you can remove your stack

```
docker stack rm wordsmith
```

## Deploy your stack on a remote Swarm cluster

The development work is done. It is time to deploy on a UAT environment.

Login to ucp https://ucp.local and enter your user credentials. Go to `My Profile` and click on `New Client Bundle` `Generate Client Bundle`
Download the zip on your local labtop and unzip it and "source" your bundle

```
$ cd ucp-bundle-docker
$ eval "$(<env.sh)"
```   

Make sure you are now communicating with a remote cluster

```
$ docker version
Client:
 Version:	18.03.0-ce-rc4
 API version:	1.30 (downgraded from 1.37)
 Go version:	go1.9.4
 Git commit:	fbedb97
 Built:	Thu Mar 15 07:33:28 2018
 OS/Arch:	darwin/amd64
 Experimental:	true
 Orchestrator:	swarm

Server:
 Engine:
  Version:	ucp/3.0.0-beta2
  API version:	1.30 (minimum version 1.20)
  Go version:	go1.9.2
  Git commit:	4f665c3
  Built:	Tue Jan 16 21:38:10 UTC 2018
  OS/Arch:	linux/amd64
  Experimental:	false
```   
Make sure you are using swarm

```
$ docker version -f '{{ .Client.Orchestrator }}'
```
Deploy the app to Swarm as a stack using the [compose file](docker-compose.yml):

```
$ docker stack deploy -c docker-compose.yml words
Creating network words_default
Creating service words_db
Creating service words_api
Creating service words_web
```

The UCP dashboard tells you have 6 services running

Click on `words_api`, check that you have 5/5 replicas and then click on `Inspect Resources`> `Containers`
You should now see the container IDs corresponding to the words_api service.

You can access the wordsmith web app on any node of the cluster on port 8081 (http://ucp:8081)  
Check that the container IDs which are displayed by the web application front end are correct.  

QUESTION: Why can access our web app on any node of the cluster?

You can remove your stack

```
docker stack rm wordsmith
```

## Deploy your stack on a remote Kube cluster

You want to deploy the same application on a Kube cluster

Docker lets you use the simple compose file format to deploy complex applications to Kubernetes.

You can target an orchestrator or another by simply setting an environment variable.

Switch to Kubernetes

```
$ export DOCKER_ORCHESTRATOR=kubernetes
$ docker version -f '{{ .Client.Orchestrator }}'
```

Deploy your stack to the Kube cluster
```
$ docker stack deploy -c docker-compose.yml words
Stack words was created
Waiting for the stack to be stable and running...
 - Service api has one container running
 - Service db has one container running
 - Service web has one container running
Stack words is stable and running
```

You can check your services by running
```
$ docker stack services words
ID                  NAME                MODE                REPLICAS            IMAGE                                     PORTS
be1805e5-31f        words_api           replicated          5/5                 docker.io/jeromebaude/k8s-wordsmith-api
be6092a6-31f        words_db            replicated          1/1                 docker.io/jeromebaude/k8s-wordsmith-db
bec7cffb-31f        words_web           replicated          1/1                 docker.io/jeromebaude/k8s-wordsmith-web
```

> Similar output can be found when running `kubectl get svc`

You can check your pods by running

```
$ docker stack ps words
ID                  NAME                        IMAGE                                     NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS
be067e84-31f        words_api-9db58c66c-8cmqt   docker.io/jeromebaude/k8s-wordsmith-api   ucp                 Running             Running about a minute ago
be10c2a2-31f        words_api-9db58c66c-b5jdt   docker.io/jeromebaude/k8s-wordsmith-api   ucp                 Running             Running about a minute ago
be1eee3e-31f        words_api-9db58c66c-qb4mq   docker.io/jeromebaude/k8s-wordsmith-api   ucp                 Running             Running about a minute ago
be235bf4-31f        words_api-9db58c66c-rkg5z   docker.io/jeromebaude/k8s-wordsmith-api   ucp                 Running             Running about a minute ago
be0c4f88-31f        words_api-9db58c66c-rnxrf   docker.io/jeromebaude/k8s-wordsmith-api   ucp                 Running             Running about a minute ago
be68b3d7-31f        words_db-6d8c4bb4c8-nfjst   docker.io/jeromebaude/k8s-wordsmith-db    ucp                 Running             Running about a minute ago
bec8a3b7-31f        words_web-f8b6bb744-l65db   docker.io/jeromebaude/k8s-wordsmith-web   ucp                 Running             Running about a minute ago                       *:0->80/tcp
```

> Similar output can be found when running `kubectl get pods`

Go to UCP and navigate to Kubernetes > Load Balancers and click on web-published.
The Port section will display the exposed URL which should look like http://ucp.local:32131
